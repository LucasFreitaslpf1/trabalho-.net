@page "/"
@using Dados;
@using Services;
@inherits OwningComponentBase<UsuarioService>

<PageTitle>Index</PageTitle>

<div style="text-align = center;">
    <h3>Teste</h3>
    <EditForm Model="@Usuario">
        <DataAnnotationsValidator />
        <div class="form-group">
            <label for="name">Nome </label>
            <InputText id="name" class="form-control" @bind-Value=Usuario.nome />
            <ValidationMessage For="() => Usuario.nome" />
            <input type="submit" class="btn btn-success" value="Salvar" @onclick="salvar" />
        </div>
    </EditForm>
    <table class="table">
        <tr>
            <th>Usuario Id</th>
            <th>Nome</th>
        </tr>
        @foreach (var user in UserList)
        {
            <tr>
                <td>
                    @user.id
                </td>
                <td>
                    @user.nome
                </td>
                <td>
                    <button class="btn btn-danger" @onclick="() => ApagarUsuario(user)">Apagar</button>
                </td>
                <td>
                    <button class="btn btn-info" @onclick="() => EditarUsuario(user)">Editar</button>
                </td>
            </tr>
        }
    </table>
</div>

@code
{
    Usuario Usuario = new();
    public IList<Usuario> UserList;

    private async Task salvar()
    {
        try
        {
            if (Usuario.id == 0)
            {
                await Service.InsertUsuario(Usuario);
            }
            else
            {
                Service.UpdateUsuario(Usuario);
            }
            Usuario = new();
            updateList();
        }
        catch (Npgsql.PostgresException E)
        {
            Console.WriteLine(E.Message);
        }

    }

    private void updateList()
    {
        UserList = Service.getAllUsuario();
    }
    protected override void OnInitialized()
    {

        UserList = Service.getAllUsuario();
    }

    private void ApagarUsuario(Usuario user)
    {
        Service.DeleteUsuario(user);
        updateList();
    }

    private void EditarUsuario(Usuario user)
    {
        Usuario = user;
    }
}
